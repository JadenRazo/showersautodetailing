---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Payment Test - Square Integration" noindex={true}>
  <div class="min-h-screen bg-gray-900 py-12 px-4">
    <div class="max-w-md mx-auto">
      <div class="bg-gray-800 rounded-lg p-6 shadow-xl">
        <h1 class="text-2xl font-bold text-white mb-6">Square Payment Test</h1>

        <div class="space-y-4 mb-6">
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">Square Application ID</label>
            <input
              type="text"
              id="appId"
              placeholder="sq0idp-xxxxxxxxxxxxx"
              class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">Booking ID</label>
            <input
              type="number"
              id="bookingId"
              placeholder="Enter booking ID"
              class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>
        </div>

        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-300 mb-2">Card Details</label>
          <div id="card-container" class="bg-white rounded-md p-3 min-h-[50px]"></div>
        </div>

        <button
          id="card-button"
          type="button"
          disabled
          class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-semibold py-3 px-4 rounded-md transition-colors"
        >
          Initialize Card Form First
        </button>

        <button
          id="init-button"
          type="button"
          class="w-full mt-3 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-md transition-colors"
        >
          Initialize Square
        </button>

        <div id="payment-status" class="mt-4 p-3 rounded-md hidden"></div>
      </div>

      <div class="mt-6 bg-gray-800 rounded-lg p-4 text-sm text-gray-400">
        <h3 class="font-semibold text-gray-300 mb-2">Instructions:</h3>
        <ol class="list-decimal list-inside space-y-1">
          <li>Enter your Square Application ID</li>
          <li>Enter the booking ID from the database</li>
          <li>Click "Initialize Square" to load the card form</li>
          <li>Enter card details and click Pay</li>
        </ol>
      </div>
    </div>
  </div>

  <script src="https://web.squarecdn.com/v1/square.js"></script>
  <script is:inline>
    let card = null;
    let payments = null;

    const appIdInput = document.getElementById('appId');
    const bookingIdInput = document.getElementById('bookingId');
    const cardButton = document.getElementById('card-button');
    const initButton = document.getElementById('init-button');
    const statusDiv = document.getElementById('payment-status');

    function showStatus(message, isError = false) {
      statusDiv.textContent = message;
      statusDiv.className = `mt-4 p-3 rounded-md ${isError ? 'bg-red-900 text-red-200' : 'bg-green-900 text-green-200'}`;
      statusDiv.classList.remove('hidden');
    }

    initButton.addEventListener('click', async () => {
      const appId = appIdInput.value.trim();
      if (!appId) {
        showStatus('Please enter Square Application ID', true);
        return;
      }

      try {
        initButton.textContent = 'Initializing...';
        initButton.disabled = true;

        payments = window.Square.payments(appId, window.location.hostname === 'localhost' ? 'sandbox' : 'production');

        card = await payments.card();
        await card.attach('#card-container');

        cardButton.disabled = false;
        cardButton.textContent = 'Pay $1.00 Deposit';
        initButton.textContent = 'Square Initialized';
        showStatus('Card form ready. Enter card details and click Pay.', false);
      } catch (e) {
        console.error('Init error:', e);
        showStatus('Failed to initialize Square: ' + e.message, true);
        initButton.disabled = false;
        initButton.textContent = 'Initialize Square';
      }
    });

    cardButton.addEventListener('click', async () => {
      const bookingId = bookingIdInput.value.trim();
      if (!bookingId) {
        showStatus('Please enter a booking ID', true);
        return;
      }

      if (!card) {
        showStatus('Please initialize Square first', true);
        return;
      }

      try {
        cardButton.disabled = true;
        cardButton.textContent = 'Processing...';

        const tokenResult = await card.tokenize();

        if (tokenResult.status === 'OK') {
          const response = await fetch('/api/payments/create-deposit-payment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              bookingId: parseInt(bookingId),
              sourceId: tokenResult.token
            })
          });

          const data = await response.json();

          if (response.ok) {
            showStatus(`Payment successful! ID: ${data.paymentId}, Status: ${data.status}, Amount: $${data.amount}`, false);
            cardButton.textContent = 'Payment Complete';
          } else {
            showStatus(`Payment failed: ${data.error}${data.details ? ' - ' + data.details : ''}`, true);
            cardButton.disabled = false;
            cardButton.textContent = 'Pay $1.00 Deposit';
          }
        } else {
          showStatus(`Card error: ${tokenResult.errors.map(e => e.message).join(', ')}`, true);
          cardButton.disabled = false;
          cardButton.textContent = 'Pay $1.00 Deposit';
        }
      } catch (e) {
        console.error('Payment error:', e);
        showStatus('Payment error: ' + e.message, true);
        cardButton.disabled = false;
        cardButton.textContent = 'Pay $1.00 Deposit';
      }
    });
  </script>
</Layout>
